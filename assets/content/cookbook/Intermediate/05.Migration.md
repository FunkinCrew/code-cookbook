[tags]: / "intermediate,misc"

# Migrating Mods to Newer Versions

Occasionally, in order to make improvements to the modding system for Friday Night Funkin', the team has to make breaking changes to features that older mods were using, causing them to have unexpected beahavior or otherwise no longer function properly. When we do this, we update the API version rule, automatically flagging any older mods and preventing them from being loaded to ensure the stability of the game.

This chapter will walk you through the process of making older mods compatible with newer versions of Friday Night Funkin'. Once you compete the steps in this guide, your mod should function as expected on newer versions.

# Migrating from v0.1.0 to v0.5.0

## Rewriting JSON merge files

In v0.5.0, the system for merging into JSON files was fundamentally reworked. Any mods which used this system previously need to refactor these files in order to work properly.

In your mod's `_merge` folder, look for any `json` files and rewrite their contents.

```jsonc
// This is the format used by older versions of the game.
{
    "merge": [
        // Set `data.difficulty` to "super_hard"
        {
	        "target": "data.difficulty",
	        "payload": "super_hard"
	    },
        // In the second element of the `data.nested.enemies` array, set `weapon` to "minigun"
	    {
	        "target": "data.nested.enemies[1].weapon",
	        "payload": "minigun"
	    }
    ]
}
```

```jsonc
// This is the format which will be used starting with v0.5.0.
[
  { "op": "replace", "path": "/playData/characters/opponent", "value": "monster" }, // Replace the value of opponent with monster.
  { "op": "add", "path": "/playData/characters/girlfriend", "value": "nene" }, // Add a new key girlfriend with the value Nene.
  { "op": "add", "path": "/playData/difficulties/1", "value": "funky" }, // Add a new value funky to the difficulty array, after easy
  { "op": "add", "path": "/playData/difficulties/-", "value": "expert" }, // Add a new value expert to the end of the difficulty array.
  { "op": "remove", "path": "/playData/garbageValue" }, // Remove the key garbageValue from the data entirely
  { "op": "test", "path": "/playData/garbageValue", "value": 37 } // Test that a given value is in the JSON. If this operation fails, the patches will be rejected.
]
```

More information about this new system can be found at [Merging Files](../Introduction/5.AppendingAndMerge.md#merging).

## Removal of Flixel UI

[Flixel UI](https://github.com/haxeflixel/flixel-ui) is a library used for developing creating UI elements and managing UI events in HaxeFlixel. In the past, this was used to power the UI of the Chart Editor, but the development team regularly found the library to be frustrating to use, and eventually switched to [HaxeUI](https://github.com/haxeui) for most of its user interfaces. 

In Friday Night Funkin' v0.5.0, the last places that the game used this library were refactored, and the game now exclusively uses a combination of manual sprite placement and HaxeUI for its user interfaces. As a result, Flixel UI was removed as a dependency.

Any mods which utilized functions and classes provided by Flixel UI may need refactoring to compensate.

## Updating the API version

Once all the migration steps above have been performed, the last step is to modify your mod's API version string. In your mod's `_polymod_meta.json` file, locate the `"api_version"` property and set it to `"0.5.0"`.

```jsonc
{
    // ...

    // Change this value from "0.1.0" to "0.5.0"
    "api_version": "0.5.0",

    // ...
}
```

> [!NOTE]
> For versions of Friday Night Funkin' between v0.3.0 and v0.4.1, the modding system always looked for `"0.1.0"` for the `api_version` and refused to load the mod in all other cases. With the v0.5.0 update, this version will now change to match the game version with every update, but only breaking changes will forcibly disable mods. Those breaking changes will be documented on this page.

# Migrating from v0.5.0 to v0.6.3

Migration from v0.5.0 to v0.6.3 requires some changes to mods.

# Update the API Version

Eric accidentally forgot to increment the API version for the game when updating to v0.6.0, and this got fixed with v0.6.3.
This means that mods won't load unless the `api_version` value in the `_polymod_meta.json` file is at least v0.6.3. This allows mod creators to perform testing and ensure their mods are compatible before releasing an update on their distribution platforms of choice. Most mods (especially ones with minimal scripting) will need no changes to work as expected, but developers should probably do some playtesting to be sure.

# Migrate from hxCodec to hxvlc

The library used for video playback has changed from hxCodec to hxvlc. This has resulted in improved performance and various bug fixes overall, but breaks mods which interact directly with the video library. This should not break any mods which use the built-in system for cutscenes in Funkin'.

Make the following changes:

```haxe
// BEFORE: Imports from the package `hxcodec`
import hxcodec.flixel.FlxVideoSprite;

// AFTER: Imports from the package `hxvlc`
import hxvlc.flixel.FlxVideoSprite;


// BEFORE: Callback to onTextureSetup
video.bitmap.onTextureSetup.add(() -> { ... });

// AFTER: Callback to onFormatSetup
video.bitmap.onFormatSetup.add(() -> { ... });


// BEFORE: Play a video by path.
video.play(videoPath);

// AFTER: Load a video by path, then play if load was successful.
// You can also run video.load() in advance before playing the video.
if (video.load(videoPath)) video.play();
```

# Options Menu Changes

The options menu received a minor refactor internally. The `pages` list was moved to its own class, which changes the code needed to access the "Preferences" menu (mainly done to add custom preferences).

We would like to standardize the process of adding custom user preferences to mods in the future eventually, but in the meantime you can make the necessary tweaks:

```haxe
// BEFORE: Retrieve the value from the page Map.
if (Std.isOfType(currentState, OptionsState)) {
    var preferencesPage = currentState.pages.get("preferences");

    // Create a new option.
    prefs.createPrefItemCheckbox(...);
}

// AFTER: Retrieve the value from the page Map, which is now inside a Codex.
if (Std.isOfType(currentState, OptionsState)) {
    var preferencesPage = currentState.optionsCodex.pages.get("preferences");

    // Create a new option.
    prefs.createPrefItemCheckbox(...);
}
```

# Sticker Changes

v0.6.0 rewrote how stickers get used by the game (and v0.6.3 rewrote it again but better this time). Any existing mods that provided stickers will probably break.

New or updating mods looking to add, remove, or replace stickers should consult the [custom Sticker Packs documentation](03.CustomStickerPacks.md)

> Author: [EliteMasterEric](https://github.com/EliteMasterEric)